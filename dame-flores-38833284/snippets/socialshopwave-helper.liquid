{% assign ssw_proxy_url = '/apps/ssw' %}
<script type="text/javascript">
  sswProxyUrl = {{ ssw_proxy_url | json }};
  sswLangs = {
    data: {},
    add: function(key, value) {
      this.data[key] = value;
    },
    t: function(key, params) {
      var value = this.data[key] || key;
      value = (value.indexOf("translation missing:") < 0) ? value : key;
      if (params) {
        value = value.replace(/%(\d+)%/g, function(match, number) {
          return (typeof params[number] != 'undefined') ? params[number] : match;
        });
      }
      return value;
    },
    p: function(key_singular, key_plural, count, params) {
      if (count == 1) {
        return this.t(key_singular, params);
      } else {
        return this.t(key_plural, params);
      }
    }
  };
  {% include 'ssw-langs' %}
  if (navigator.userAgent.match(/Android/i)
      || navigator.userAgent.match(/webOS/i)
      || navigator.userAgent.match(/iPhone/i)
      || navigator.userAgent.match(/iPad/i)
      || navigator.userAgent.match(/iPod/i)
      || navigator.userAgent.match(/BlackBerry/i)
  ) {
    document.body.className += " ssw-touch";
  }

  function sswGetParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }
</script>
{{ 'socialshopwave.css'| asset_url | stylesheet_tag }}
{{ 'socialshopwave-custom.css'| asset_url | stylesheet_tag }}
<style id="ssw-design-preview"></style>
{{ 'ssw-libraries.js' | asset_url | script_tag }}
{{ 'ssw-fontello.min.css'| asset_url | stylesheet_tag }}
{% if customer %}
  <input id="ssw_cid" type="hidden" value="{{ customer.id}}" />
{% else %}
  <input id="ssw_cid" type="hidden" value="0" />
{% endif %}

{% capture ssw_login_helper %}{% include 'ssw-login-helper' %}{% endcapture %}
{% unless ssw_login_helper contains 'Liquid error' %}
	{{ ssw_login_helper }}
{% endunless %}

{% capture ssw_review_helper %}{% include 'ssw-review-helper' %}{% endcapture %}
{% unless ssw_review_helper contains 'Liquid error' %}
	{{ ssw_review_helper }}
{% endunless %}

{% capture ssw_community_helper %}{% include 'ssw-community-helper' %}{% endcapture %}
{% unless ssw_community_helper contains 'Liquid error' %}
	{{ ssw_community_helper }}
{% endunless %}

{% capture ssw_instagram_helper %}{% include 'ssw-instagram-helper' %}{% endcapture %}
{% unless ssw_instagram_helper contains 'Liquid error' %}
	{{ ssw_instagram_helper }}
{% endunless %}

{% capture ssw_sharing_helper %}{% include 'ssw-sharing-helper' %}{% endcapture %}
{% unless ssw_sharing_helper contains 'Liquid error' %}
	{{ ssw_sharing_helper }}
{% endunless %}

{% capture ssw_comment_helper %}{% include 'ssw-comment-helper' %}{% endcapture %}
{% unless ssw_comment_helper contains 'Liquid error' %}
	{{ ssw_comment_helper }}
{% endunless %}

{% capture ssw_ask_friends_helper %}{% include 'ssw-ask-friends-helper' %}{% endcapture %}
{% unless ssw_ask_friends_helper contains 'Liquid error' %}
	{{ ssw_ask_friends_helper }}
{% endunless %}

{% capture ssw_fave_helper %}{% include 'ssw-fave-helper' %}{% endcapture %}
{% unless ssw_fave_helper contains 'Liquid error' %}
	{{ ssw_fave_helper }}
{% endunless %}

{% capture ssw_invite_helper %}{% include 'ssw-invite-helper' %}{% endcapture %}
{% unless ssw_invite_helper contains 'Liquid error' %}
	{{ ssw_invite_helper }}
{% endunless %}

<script type="text/javascript">
  var shop_url = 'http://' + Shopify.shop;
  var shop_name = "{{shop.name}}";
  var sswJqLoaded = false;
  var ssw = false;
  var userChecked = false;
  var loadSswWidgetListingInterval = [];
  var sswProductPins = [];
    var M_DOMAIN = 'getstore.me';
    var HE_DOMAIN = 'http://www.socialshopwave.com';
  var currency_format = "{{ shop.money_with_currency_format }}";
  //load jquery if not loaded before
  function loadScript(url, callback) {

    var script = document.createElement("script")
    script.type = "text/javascript";

    if (script.readyState) { //IE
      script.onreadystatechange = function () {
        if (script.readyState == "loaded" ||
            script.readyState == "complete") {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function () {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName("head")[0].appendChild(script);
  }

  if ((typeof jQuery === 'undefined') || jQuery.fn.jquery.indexOf("1.8") != -1 || (parseFloat(jQuery.fn.jquery) <= 1.7)) {
    loadScript('//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js', function () {
      ssw = jQuery.noConflict(true);
      sswJqLoaded = true;
      sswCookieLoad(ssw);
      checkUser(ssw);
      if(typeof initSocialButtons == 'function')
        initSocialButtons(ssw);
    });
  } else {
    sswJqLoaded = true;
    ssw = jQuery;
    sswCookieLoad(jQuery);
    checkUser(jQuery);
    if(typeof initSocialButtons == 'function')
      initSocialButtons(ssw);
  }

  /// cookie.js
  function sswCookieLoad(jQuery) {
    jQuery.cookie = function (key, value, options) {

      // key and value given, set cookie...
      if (arguments.length > 1 && (value === null || typeof value !== "object")) {
        options = jQuery.extend({}, options);

        if (value === null) {
          options.expires = -1;
        }

        if (typeof options.expires === 'number') {
          var days = options.expires, t = options.expires = new Date();
          t.setDate(t.getDate() + days);
        } else if (typeof options.expires === 'string') {
          var hours = parseInt(options.expires), t = options.expires = new Date();
          t.setHours(t.getHours() + hours);
        }

        return (document.cookie = [
          encodeURIComponent(key), '=',
          options.raw ? String(value) : encodeURIComponent(String(value)),
          options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
          options.path ? '; path=' + options.path : '',
          options.domain ? '; domain=' + options.domain : '',
          options.secure ? '; secure' : ''
        ].join(''));
      }

      // key and possibly options given, get cookie...
      options = value || {};
      var result, decode = options.raw ? function (s) {
        return s;
      } : decodeURIComponent;
      return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? decode(result[1]) : null;
    };
    if (jQuery.cookie('hesid') == null)
      jQuery.cookie('hesid', 'sid' + new Date().getTime(), {path: '/'});
  }
  function sswCookie(key, value, exphours) {
    var cookie;
    exphours = exphours ? exphours : 24 * 7;
    if (value && exphours) {
      var exdate = new Date();
      exdate.setHours(exdate.getHours() + exphours);
      cookie = escape(value) + ((exphours == null) ? "" : "; expires=" + exdate.toUTCString());
      document.cookie = key + "=" + cookie;
      return this;
    }
    var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + key.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
    ));
    return matches ? decodeURIComponent(matches[1]) : undefined;
  }

  function checkUser($) {
    var data = {'_sid': sswCookie('hesid'), 'hash_key': sswCookie('hash_key')};
    {% if shop.customer_accounts_enabled and customer %}
    data.customer_id = {{customer.id}};
    {% endif %}
    if(typeof sswCookie('cart') != 'undefined'){
      data.cart_token = sswCookie('cart');
    }
    if(typeof sswCookie('ssw_our_session') != 'undefined'){
      data.ssw_our_session = sswCookie('ssw_our_session');
    }
    if(typeof sswCookie('ssw_referrer') != 'undefined'){
      data.ssw_referrer = sswCookie('ssw_referrer');
    }
    $.ajax({
      type: 'post',
      url: sswProxyUrl + '/lite2/user/check',
      data: data,
      success: function (response) {
        if (typeof response.discount != 'undefined' && response.discount) {
          $('#ssw-discount-code').html(response.discount.code);
          $('#discount-date').html('Valid until ' + response.discount.date);
          $('#ssw-discount-modal').sswModal();
        }
        if (response.spp) {
          ssw('body').append(
              ssw('<div>', {class: 'ssw-modal ssw-hide ssw-fade', id: 'purchase_modal', role:"modal", 'aria-hidden':"false" }).append(
                  ssw('<div>', {class: 'ssw-modal-dialog'}).append(
                      ssw('<div>', {class: 'ssw-modal-content'}).append(
                          ssw('<div>', {class: 'ssw-modal-body'}).append(
                              '<button aria-hidden="true" data-dismiss="ssw-modal" class="ssw-close" type="button">&times</button><h2>Share Your Order</h2>Thank you for your order! Let others know about your great purchase. Would like to share this only on our site?<br><br><label class="radio"><input type="radio" checked="checked" class="input"> Yes, share my purchases into Feed</label><label class="radio"><input type="radio" class="input"> No, don\'t share my purchases</label>'
                          )
                      ).append(
                          ssw('<div>', {class: 'ssw-modal-footer'}).append(
                              '<button class="btn">Remember my choice</button> or <a aria-hidden="true" data-dismiss="modal" href="javascript://">Cancel</a>'
                          )
                      )
                  )
              )
          )
        }
        if (!ssw.isEmptyObject(response.fb_data) && typeof targetFbShareSetting != 'undefined') {
          targetFbShareSetting('purchase', response.fb_data.id, response.fb_data.name, response.fb_data.product_id, '', '');
        } else if (response.show_follow == true && typeof showFollowPopup != 'undefined') {
          setTimeout(function(){
            showFollowPopup();
          }, 5000);
        }
        if (response.result == 'logout' || response.result == "User not found") {
          sswCookie('hesid', null);
        }
        if (response.hash_key) {
          ssw.cookie('hash_key', response.hash_key, {
            expires: 30,
            path: '/'
          });
        }
        if(typeof sswCookie('cart') == 'undefined' && response.cart){
          ssw.cookie('cart', response.cart, {
            expires: 14,
            path: '/'
          });
        }

        userChecked = true;

        window.ssw.isFree = response.isFree;

        if( response.isFree ) {
          $('#login_modal .ssw-modal-footer, #signup_modal .ssw-modal-footer, #notifyModal .ssw-modal-footer, .ssw-social-login-widget, #ssw-product-modal .ssw-modal-footer, #ssw-action-modal .ssw-modal-footer').append(response.watermark);
        }
      },
      dataType: 'json',
      async: true
    });
  }

  {% if shop.customer_accounts_enabled and customer %}
  if (sswGetParameterByName('checkout_url')) {
    location.href = '/cart';
  }
  {% endif %}
  {% if template contains 'product' and product %}
  if(typeof sswProductViewInterval == 'undefined'){
    var sswProductViewInterval = setInterval(function(){
      if(typeof sswJqLoaded != 'undefined' && sswJqLoaded){
        clearInterval(sswProductViewInterval);
        var data = {'product_id': {{product.id}},
          '_sid':sswCookie('hesid'),
          'hash_key':sswCookie('hash_key')
        };
        if (sswCookie('mail_id'))
          data.resource_id = sswCookie('mail_id');
        ssw.get(sswProxyUrl + '/lite2/product-view', data, function (data) {
        }, 'json');
      }
    }, 300);
  }
  {% endif %}
</script>
{{ ssw_proxy_url | append: '/public/js/product-pins.js' | script_tag }}

<script type="text/javascript">
  if( !('placeholder' in document.createElement('input')) ) {
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = sswProxyUrl + '/public/js/core/placeholders.js';

    // Fire the loading
    head.appendChild(script);
  }
</script>
<div id="ssw-discount-modal" class="ssw-modal ssw-fade" aria-hidden="true" role="modal">
  <div class="ssw-modal-dialog">
    <div class="ssw-modal-content">
      <div class="ssw-modal-body">
        <button type="button" class="ssw-close" data-dismiss="ssw-modal" aria-hidden="true">&times;</button>
        <span>{{ 'socialshopwave.your_discount_code' | t }}</span>
        <br />
        <h1 id="ssw-discount-code"></h1>
        <br />
        <span id="discount-date"></span>
      </div>
    </div>
  </div>
</div>

{% include 'ssw-cart-modal' %}
{% include 'ssw-product-modal' %}
<script type="text/javascript">
  if (window.addEventListener){ addEventListener("message", sswListener); }
  else { window.attachEvent("onmessage", sswListener) }
  function  sswListener(event){
    if(typeof event.data.ssw_message != 'undefined' && event.data.ssw_message){
      if(typeof event.data.hide_admin_bar && event.data.hide_admin_bar){
        ssw('#admin_bar_iframe').hide();
        ssw('html').css('margin-top', '0px');
      }
      if(typeof event.data.css_code != 'undefined' && event.data.css_code){
        ssw('#ssw-design-preview').html(event.data.css_code);
      }
      if(typeof event.data.js_code != 'undefined' && event.data.js_code){
        eval(event.data.js_code);
      }
    }
  }
</script>